@inherits Dynamicweb.Rendering.ViewModelTemplate<Dynamicweb.Frontend.ParagraphViewModel>
@using Dynamicweb.Rendering
@using Dynamicweb.Ecommerce.ProductCatalog
@using Dynamicweb.Frontend
@using System.Web

@{ 
	bool isVisualEditor = !string.IsNullOrEmpty(HttpContext.Current.Request.QueryString.Get("VisualEdit")) ? Convert.ToBoolean(HttpContext.Current.Request.QueryString.Get("VisualEdit")) : false;

	ProductViewModel product = new ProductViewModel();

	if (System.Web.HttpContext.Current.Items.Contains("ProductDetails"))
	{
		product = (ProductViewModel)System.Web.HttpContext.Current.Items["ProductDetails"];
	}

	//Collect the images
	var selectedImageCategories = Model.Item.GetList("ImageAssets").SelectedValues;
	var images = product.AssetCategories.Where(x => selectedImageCategories.Contains(x.SystemName)).SelectMany(x => x.Assets).Union(product.ImagePatternImages);

	int totalImages = 0;
	foreach (MediaViewModel asset in images) {
		var assetName = asset.Value.ToLower(); 
		if (assetName.Contains(".jpg") || assetName.Contains(".webp") || assetName.Contains(".png") || assetName.Contains(".gif")) {
			totalImages++;
		} 
	}
}


@* Get images from selected categories or get all images *@
<div class="item">
	@if (totalImages != 0)
	{
		@* Show the gallery on large screens *@
		<div class="d-none d-lg-block">
			<div class="row g-4">
				@foreach (MediaViewModel asset in images) {
					var assetName = asset.Value.ToLower(); 
					if (assetName.Contains(".jpg") || assetName.Contains(".webp") || assetName.Contains(".png") || assetName.Contains(".gif")) {
						string colClass = totalImages > 1 ? "col-lg-6" : "col-12";

						<div class="@colClass">
							@RenderImage(asset)
						</div>
					}
				}
			</div>

			<!-- Modal -->
			<div class="modal fade" id="ImageModal_@Model.ID" tabindex="-1" aria-labelledby="@Translate("Full image")" aria-hidden="true">
			  <div class="modal-dialog modal-fullscreen">
				<div class="modal-content">
				  <div class="modal-header">
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="@Translate("Close")"></button>
				  </div>
				  <div class="modal-body">
						<div class="ratio ratio-16x9">
							<div class="d-flex align-items-center w-100">
								<img src="" alt="" style="object-fit: cover;" id="FullImage_@Model.ID" class="w-100">
							</div>
						</div>
				  </div>
				</div>
			  </div>
			</div>
		</div>


		@* Show the thumbs on small screens *@
		<div class="d-block d-lg-none mini-product-image-slider">
			<div id="SmallScreenImages_@Model.ID">
				@foreach (MediaViewModel asset in images) {
					var assetName = asset.Value.ToLower(); 
					if (assetName.Contains(".jpg") || assetName.Contains(".webp") || assetName.Contains(".png") || assetName.Contains(".gif")) {
						@RenderImage(asset)
					}
				}
			</div>

			<!-- Tiny slider -->
			<script type="module">
				var slider = tns({
					container: '#SmallScreenImages_@Model.ID',
					items: 1,
					mode: 'carousel',
					navPosition: 'bottom',
					mouseDrag: true,
					touch: true,
					arrowKeys: true,
					nav: true,
					loop: false,
					controls: false,
				});
			</script>
		</div>
	}
</div>


@helper RenderImage(MediaViewModel asset) { 
	string ratio = Model.Item?.GetList("ImageAspectRatio")?.SelectedValue != "0" && Model.Item?.GetList("ImageAspectRatio")?.SelectedValue != "" ? Model.Item.GetList("ImageAspectRatio").SelectedValue : "";
	string ratioCssClass = ratio != "" ? "ratio" : "";
	string ratioVariable = ratio != "" ? "--bs-aspect-ratio: " + ratio : "";

	string imagePath = asset.Value;
	string imagePathXs       = "/Admin/Public/GetImage.ashx?width=" + 920 + "&image=" + imagePath + "&Format=WebP";
	string imagePathS        = "/Admin/Public/GetImage.ashx?width=" + 1280 + "&image=" + imagePath + "&Format=WebP";
	string imagePathM        = "/Admin/Public/GetImage.ashx?width=" + 1420 + "&image=" + imagePath + "&Format=WebP";
	string imagePathL        = "/Admin/Public/GetImage.ashx?width=" + 1920 + "&image=" + imagePath + "&Format=WebP";
	string imagePathXl       = "/Admin/Public/GetImage.ashx?width=" + 2560 + "&image=" + imagePath + "&Format=WebP";
	string imagePathFallBack = "/Admin/Public/GetImage.ashx?width=" + 2560 + "&image=" + imagePath + "&Format=PNG";

	<div class="border p-3">
		<div class="@ratioCssClass" style="@(ratioVariable); cursor: pointer;" data-bs-toggle="modal" data-bs-target="#ImageModal_@Model.ID">
			<div class="d-flex align-items-center w-100">
				<img srcset="
					@imagePathXs 320w,
					@imagePathS 640w,
					@imagePathM 1280w,
					@imagePathL 1920w,
					@imagePathXl 2560w"
				sizes="(max-width: 2560px) 480px, 800px"
				src="@imagePathFallBack"
				height=""
				width=""
				loading="lazy"
				alt="@asset.Name"
				class="w-100"
				onclick="document.querySelector('#FullImage_@Model.ID').src = this.src">
			</div>
		</div>
	</div>
}
