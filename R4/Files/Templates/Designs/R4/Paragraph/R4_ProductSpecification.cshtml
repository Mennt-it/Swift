@inherits Dynamicweb.Rendering.ViewModelTemplate<Dynamicweb.Frontend.ParagraphViewModel>
@using Dynamicweb.Ecommerce.ProductCatalog

@{ 
	ProductViewModel product = new ProductViewModel();

	if (Dynamicweb.Context.Current.Items.Contains("ProductDetails"))
	{
		product = (ProductViewModel)Dynamicweb.Context.Current.Items["ProductDetails"];
	} 

	
	IEnumerable<string> selectedDisplayGroupIds = Model.Item.GetList("DisplayGroups").SelectedValues;
	List<CategoryFieldViewModel> displayGroups = new List<CategoryFieldViewModel>();

	foreach (var selection in selectedDisplayGroupIds)
	{
		foreach (CategoryFieldViewModel group in product.FieldDisplayGroups.Values)
		{		
			if (selection == group.Id) {
				displayGroups.Add(group);
			}
		}
	}

	bool hideTitle = Model.Item.GetBoolean("HideTitle");

	string theme = !string.IsNullOrWhiteSpace(Model.Item.GetRawValueString("Theme")) ? " theme " + Model.Item.GetRawValueString("Theme").Replace(" ", "").Trim().ToLower() : "";

	string titleFontSize = Model.Item.GetRawValueString("TitleFontSize", "display-4");

	string contentPadding = Model.Item.GetRawValueString("ContentPadding", "");
	contentPadding = contentPadding == "small" ? "p-2 p-md-3" : contentPadding;
	contentPadding = contentPadding == "large" ? "p-4 p-md-5" : contentPadding;
}

<div class="@(contentPadding)@(theme) h-100">
	@if ((product.ProductFields != null && Model.Item.GetBoolean("ProductFields")) || (product.ProductCategories != null && Model.Item.GetBoolean("CategoryFields")) || (displayGroups.Count != 0)) {
		if (!hideTitle)
		{
			<div class="text-start pb-2 pb-lg-4">
				<h2 class="@titleFontSize">@Model.Item.GetString("Title")</h2>
			</div>
		}
	}

	@if (displayGroups.Count != 0) {
		foreach (var group in displayGroups) {
			bool hideHeader = Model.Item.GetBoolean("HideGroupHeaders");

			if (!hideHeader) { 
				<h4 class="h4 mb-4">@group.Name</h4>
			}

			<dl class="definition-list">
				@foreach (var field in group.Fields) {
					@RenderField(field.Value)  
				}  
			</dl>
		}
	}

	@if (product.ProductFields != null && Model.Item.GetBoolean("ProductFields")) {
		if (product.ProductFields.Count > 0) {
			<dl class="definition-list">
				@foreach (var field in product.ProductFields) {
					@RenderField(field.Value)  
				}  
			</dl>
		}
	}

	@if (product.ProductCategories != null && Model.Item.GetBoolean("CategoryFields")) {
		if (product.ProductCategories.Count > 0) {
			foreach (var group in product.ProductCategories) {
				CategoryFieldViewModel category = group.Value;
				bool hideHeader = Model.Item.GetBoolean("HideGroupHeaders");

				if (!hideHeader) { 
					<h4 class="h4 mb-4">@group.Key</h4>
				}

				<dl class="definition-list">
					@foreach (var field in category.Fields) {
						@RenderField(field.Value)  
					}  
				</dl>
			}
		}
	}
</div>

@helper RenderField(FieldValueViewModel field) { 
	string fieldValue = field?.Value != null ? field.Value.ToString() : "";
	bool noValues = false;

	if (field.Value.GetType() == typeof(System.Collections.Generic.List<FieldOptionValueViewModel>)) {
		System.Collections.Generic.List<FieldOptionValueViewModel> values = field.Value as System.Collections.Generic.List<FieldOptionValueViewModel>;
		noValues = values.Count > 0 ? false : true;
	}

	if (!string.IsNullOrEmpty(fieldValue) && noValues == false) {
		fieldValue = fieldValue == "False" ? Translate("No") : fieldValue;
		fieldValue = fieldValue == "True" ? Translate("Yes") : fieldValue;

		bool isColor = false;

		<div class="definition-list-item gap-3">
			<dt class="fw-bold">@field.Name</dt>
			<dd>
				@if (field.Value.GetType() == typeof(System.Collections.Generic.List<FieldOptionValueViewModel>))
				{
					int valueCount = 0;
					System.Collections.Generic.List<FieldOptionValueViewModel> values = field.Value as System.Collections.Generic.List<FieldOptionValueViewModel>;
					int totalValues = values.Count;

					foreach (FieldOptionValueViewModel option in values)
					{
						if (option.Value.Substring(0,1) == "#") {
							isColor = true;   
						}

						@RenderFieldValue(option.Value, isColor);
						if (valueCount != totalValues && valueCount < (totalValues - 1)) {
							if (isColor) {
<text> </text>
							} else {
<text>, </text>
							}
						}
						valueCount++;
					}
				}
				else
				{
					if (fieldValue.Substring(0,1) == "#") {
						isColor = true;   
					}

					@RenderFieldValue(fieldValue, isColor);
				}
			</dd>
		</div>
	}
}

@helper RenderFieldValue(string fieldValue, bool isColor) { 
	if (!isColor) {
		@fieldValue
	} else {
		<span class="colorbox-sm" style="background-color: @fieldValue" title="@fieldValue"></span>
	}
}
