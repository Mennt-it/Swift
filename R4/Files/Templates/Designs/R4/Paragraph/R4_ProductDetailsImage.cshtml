@inherits Dynamicweb.Rendering.ViewModelTemplate<Dynamicweb.Frontend.ParagraphViewModel>
@using Dynamicweb.Ecommerce.ProductCatalog


@{ 
	bool isVisualEditor = !string.IsNullOrEmpty(Dynamicweb.Context.Current.Request.QueryString.Get("VisualEdit")) ? Convert.ToBoolean(Dynamicweb.Context.Current.Request.QueryString.Get("VisualEdit")) : false;

	ProductViewModel product = new ProductViewModel();

	if (Dynamicweb.Context.Current.Items.Contains("ProductDetails"))
	{
		product = (ProductViewModel)Dynamicweb.Context.Current.Items["ProductDetails"];
	}

	//Collect the images
	var selectedImageCategories = Model.Item.GetList("ImageAssets").SelectedValues;
	var images = product.AssetCategories.Where(x => selectedImageCategories.Contains(x.SystemName)).SelectMany(x => x.Assets).Union(product.ImagePatternImages);
	string ratio = Model.Item?.GetList("ImageAspectRatio")?.SelectedValue != "0" && Model.Item?.GetList("ImageAspectRatio")?.SelectedValue != "" ? Model.Item.GetList("ImageAspectRatio").SelectedValue : "";
	string mainRatioCssClass = ratio != "" ? "ratio" : "";
	string mainRatioVariable = ratio != "" ? "--bs-aspect-ratio: " + ratio : "";
	string mainImagePath = "";

	int totalImages = 0;
	foreach (MediaViewModel asset in images) {
		var assetName = asset.Value.ToLower();
		if (assetName.Contains(".jpg") || assetName.Contains(".webp") || assetName.Contains(".png") || assetName.Contains(".gif")) {
			if (totalImages == 0) {
				mainImagePath = asset.Value;
			}
			totalImages++;
		}
	}

	string mainImageColClass = totalImages > 1 ? "col-10" : "col-12";

	string padding = "";
	string theme = !string.IsNullOrEmpty(Model.Item.GetString("Theme")) ? Model.Item.GetString("Theme").ToLower() : "";
	if (theme != "theme default" && theme != "")
	{
		theme = String.Concat(theme.Where(c => !Char.IsWhiteSpace(c)));
		theme = theme.Replace("theme", "");
		theme = " theme theme-" + theme;
		padding = "p-4";
	} else {
		theme = "";
	}
}


@* Get images from selected categories or get all images *@
@if (totalImages != 0)
{
	string imagePathXs       = "/Admin/Public/GetImage.ashx?width=" + 920 + "&image=" + mainImagePath + "&Format=WebP";
	string imagePathS        = "/Admin/Public/GetImage.ashx?width=" + 1280 + "&image=" + mainImagePath + "&Format=WebP";
	string imagePathM        = "/Admin/Public/GetImage.ashx?width=" + 1420 + "&image=" + mainImagePath + "&Format=WebP";
	string imagePathL        = "/Admin/Public/GetImage.ashx?width=" + 1920 + "&image=" + mainImagePath + "&Format=WebP";
	string imagePathXl       = "/Admin/Public/GetImage.ashx?width=" + 2560 + "&image=" + mainImagePath + "&Format=WebP";
	string imagePathFallBack = "/Admin/Public/GetImage.ashx?width=" + 2560 + "&image=" + mainImagePath + "&Format=PNG";

	@* Show image + thumbs on large screens *@
	<div class="d-none d-lg-block">
		<div class="row g-3">
			@if (totalImages > 1)
			{
				<div class="col-2">
					<div id="LargeScreenImages_@Model.ID">
						@foreach (MediaViewModel asset in images) {
							var assetName = asset.Value.ToLower(); 
							if (assetName.Contains(".jpg") || assetName.Contains(".webp") || assetName.Contains(".png") || assetName.Contains(".gif")) {
								@RenderThumbnail(asset, product)
							}
						}
					</div>
				</div>
			}

			@* Main image *@
			<div class="@mainImageColClass">
				<div class="@(padding)@(theme)">
					<div class="@mainRatioCssClass" style="@(mainRatioVariable);" data-bs-toggle="modal" data-bs-target="#ImageModal_@Model.ID">
						<div class="d-flex align-items-center justify-content-center">
							<img id="MainImage_@Model.ID" srcset="
									@imagePathXs 320w,
									@imagePathS 640w,
									@imagePathM 1280w,
									@imagePathL 1920w,
									@imagePathXl 2560w"
								sizes="(max-width: 2560px) 480px, 800px"
								src="@imagePathFallBack"
								height=""
								width=""
								loading="lazy"
								class="mw-100 mh-100"
								style="cursor: pointer"
								alt="@product.Name"
								onclick="document.querySelector('#FullImage_@Model.ID').src = this.src">
						</div>
					</div>
				</div>
			</div>
		</div>

		@* Tiny slider *@
		<script type="module">
			var slider = tns({
			container: '#LargeScreenImages_@Model.ID',
			items: 5.5,
			gutter: 8,
			axis: 'vertical',
			arrowKeys: false,
			nav: false,
			loop: false,
			controls: false,
			lazyload: true
		});
		</script>
	</div>


	@* Modal *@
	<div class="modal fade" id="ImageModal_@Model.ID" tabindex="-1" aria-labelledby="@Translate("Full image")" aria-hidden="true">
		<div class="modal-dialog modal-fullscreen">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="@Translate("Close")"></button>
			</div>
			<div class="modal-body">
				<div class="ratio ratio-16x9 h-100">
					<div class="d-flex align-items-center justify-content-center">
							<img src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" alt="" id="FullImage_@Model.ID" class="mw-100 mh-100">
					</div>
				</div>
			</div>
		</div>
		</div>
	</div>


	@* Show the thumbs on small screens *@
	<div class="d-block d-lg-none">
		<div id="SmallScreenImages_@Model.ID" class="">
			@foreach (MediaViewModel asset in images) {
				var assetName = asset.Value.ToLower(); 
				if (assetName.Contains(".jpg") || assetName.Contains(".webp") || assetName.Contains(".png") || assetName.Contains(".gif")) {
					@RenderImage(asset, product)
				}
			}
		</div>

		@* Tiny slider *@
		<script type="module">
			var slider = tns({
				container: '#SmallScreenImages_@Model.ID',
				items: 1.2,
				gutter: 8,
				mode: 'carousel',
				navPosition: 'bottom',
				mouseDrag: true,
				touch: true,
				arrowKeys: true,
				nav: true,
				loop: false,
				rewind: false,
				controls: false,
			});
		</script>
	</div>
}


@helper RenderThumbnail(MediaViewModel asset, ProductViewModel product) { 
	string imagePath = !string.IsNullOrEmpty(asset.Value) ? asset.Value : product.DefaultImage.Value;
	string imagePathXs       = "/Admin/Public/GetImage.ashx?width=" + 920 + "&image=" + imagePath + "&Format=WebP";
	string imagePathS        = "/Admin/Public/GetImage.ashx?width=" + 1280 + "&image=" + imagePath + "&Format=WebP";
	string imagePathM        = "/Admin/Public/GetImage.ashx?width=" + 1420 + "&image=" + imagePath + "&Format=WebP";
	string imagePathL        = "/Admin/Public/GetImage.ashx?width=" + 1920 + "&image=" + imagePath + "&Format=WebP";
	string imagePathXl       = "/Admin/Public/GetImage.ashx?width=" + 2560 + "&image=" + imagePath + "&Format=WebP";
	string imagePathFallBack = "/Admin/Public/GetImage.ashx?width=" + 2560 + "&image=" + imagePath + "&Format=PNG";

	<div class="border ratio ratio-16x9">
		<div class="d-flex align-items-center justify-content-center">
			<img id="MainImage_@Model.ID" srcset="
				@imagePathXs 320w,
				@imagePathS 640w,
				@imagePathM 1280w,
				@imagePathL 1920w,
				@imagePathXl 2560w"
			sizes="(max-width: 2560px) 480px, 800px"
			src="@imagePathFallBack"
			height=""
			width=""
			class="mw-100 mh-100"
			style="cursor: pointer"
			alt="@asset.Name"
			onclick="document.querySelector('#MainImage_@Model.ID').src = this.src">
		</div>
	</div>
}

@helper RenderImage(MediaViewModel asset, ProductViewModel product) {
	string imagePath = !string.IsNullOrEmpty(asset.Value) ? asset.Value : product.DefaultImage.Value;
	string imagePathXs       = "/Admin/Public/GetImage.ashx?width=" + 920 + "&image=" + imagePath + "&Format=WebP";
	string imagePathS        = "/Admin/Public/GetImage.ashx?width=" + 1280 + "&image=" + imagePath + "&Format=WebP";
	string imagePathM        = "/Admin/Public/GetImage.ashx?width=" + 1420 + "&image=" + imagePath + "&Format=WebP";
	string imagePathL        = "/Admin/Public/GetImage.ashx?width=" + 1920 + "&image=" + imagePath + "&Format=WebP";
	string imagePathXl       = "/Admin/Public/GetImage.ashx?width=" + 2560 + "&image=" + imagePath + "&Format=WebP";
	string imagePathFallBack = "/Admin/Public/GetImage.ashx?width=" + 2560 + "&image=" + imagePath + "&Format=PNG";

	string ratio = Model.Item?.GetList("ImageAspectRatio")?.SelectedValue != "0" && Model.Item?.GetList("ImageAspectRatio")?.SelectedValue != "" ? Model.Item.GetList("ImageAspectRatio").SelectedValue : "";
	string ratioCssClass = ratio != "" ? "ratio" : "";
	string ratioVariable = ratio != "" ? "--bs-aspect-ratio: " + ratio : "";

	<div class="@ratioCssClass" style="@(ratioVariable); cursor: pointer;" data-bs-toggle="modal" data-bs-target="#ImageModal_@Model.ID">
		<div class="d-flex align-items-center justify-content-center">
			<img id="MainImage_@Model.ID" srcset="
				@imagePathXs 320w,
				@imagePathS 640w,
				@imagePathM 1280w,
				@imagePathL 1920w,
				@imagePathXl 2560w"
			sizes="(max-width: 2560px) 480px, 800px"
			src="@imagePathFallBack"
			height=""
			width=""
			loading="lazy"
			class="mw-100 mh-100"
			style="cursor: pointer"
			alt="@asset.Name"
			onclick="document.querySelector('#FullImage_@Model.ID').src = this.src">	
		</div>
	</div>
}
