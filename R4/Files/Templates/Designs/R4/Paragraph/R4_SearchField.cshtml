@inherits Dynamicweb.Rendering.ViewModelTemplate<Dynamicweb.Frontend.ParagraphViewModel>
@{
    string layout = Model.Item.GetRawValueString("Layout", "field");
	string horizontalAlign = !string.IsNullOrEmpty(Model.Item.GetRawValueString("HorizontalAlignment")) ? " justify-content-" + Model.Item.GetRawValueString("HorizontalAlignment") : "";
	string paragraphId = Model.ID.ToString();

	string searchLayout = Model.Item.GetRawValueString("Layout", "");
	searchLayout = searchLayout == "icon" ? "mx-n3" : searchLayout;
}

<div class="d-flex align-items-center h-100 py-2 my-auto @searchLayout @(horizontalAlign)">
	@if (layout == "field") {
		@SearchField("normal")
	}

	@if (layout == "small-field") {
		@SearchField("small")
	}

	@if (layout == "icon") {
		string iconPath = "/Files/Templates/Designs/R4/Assets/icons/";

		<button class="btn px-3 py-2" data-bs-toggle="modal" data-bs-target="#searchModal_@paragraphId">
			<span class="icon-3">
				@ReadFile(iconPath+"search.svg")
			</span>
		</button>

		<div class="modal fade" id="searchModal_@paragraphId" tabindex="-1" data-bs-backdrop="false" >
			<div class="modal-dialog modal-fullscreen">
				<div class="modal-content">
					<div class="modal-header justify-content-between">
						<h5 class="modal-title">@Translate("Search")</h5>
						<a data-bs-dismiss="modal" aria-label="Close">
							<span class="icon-3">
								@ReadFile(iconPath+"x.svg")
							</span>
						</a>
					</div>
					<div class="modal-body">
						@SearchField("normal")
					</div>
				</div>
			</div>
		</div>
	}
</div>

@helper SearchField(string size) { 
	string searchResultsPageId = Model.Item.GetLink("SearchResultsPage") != null ? Model.Item.GetLink("SearchResultsPage").PageId.ToString() : "";
	string productListPage = Model.Item.GetLink("ProductListPage") != null ? Model.Item.GetLink("ProductListPage").PageId.ToString() : "";
    string productDetailsPage = Model.Item.GetLink("ProductDetailsPage") != null ? Model.Item.GetLink("ProductDetailsPage").PageId.ToString() : "";
	string width = size == "small" ? "style=\"max-width: 260px\"" : "style=\"width: 100%\"";
	string iconPath = "/Files/Templates/Designs/R4/Assets/icons/";

	string searchFieldShape = Model.Item.GetRawValueString("SearchFieldShape", "");
	searchFieldShape = searchFieldShape == "boxed" ? "boxed" : searchFieldShape;
	searchFieldShape = searchFieldShape == "rounded" ? "rounded" : searchFieldShape;
	searchFieldShape = searchFieldShape == "pill" ? "rounded-pill" : searchFieldShape;

	string themeSearch = !string.IsNullOrWhiteSpace(Model.Item.GetRawValueString("ThemeSearch")) ? " theme " + Model.Item.GetRawValueString("ThemeSearch").Replace(" ", "").Trim().ToLower() : "";
	string themeResults = !string.IsNullOrWhiteSpace(Model.Item.GetRawValueString("ThemeResults")) ? " theme " + Model.Item.GetRawValueString("ThemeResults").Replace(" ", "").Trim().ToLower() : "";

	string searchTerm = string.Empty;
	List<string> searchHistory = new List<string>();
	if (Dynamicweb.Context.Current.Session["_searchHistory"] != null)
	{
		searchHistory = (List<string>)Dynamicweb.Context.Current.Session["_searchHistory"];
	}
	if (!string.IsNullOrEmpty(Dynamicweb.Context.Current.Request["q"]))
	{
		searchTerm = Dynamicweb.Context.Current.Request["q"];

		if (searchHistory.Contains(searchTerm))
		{
			searchHistory.Remove(searchTerm);
		}
		searchHistory.Add(searchTerm);
		Dynamicweb.Context.Current.Session.Add("_searchHistory", searchHistory);
	}
	string groupIdQueryParameter = string.Empty;
	if (!string.IsNullOrEmpty(Dynamicweb.Context.Current.Request["GroupID"]))
	{
		groupIdQueryParameter = "&GroupID=" + Dynamicweb.Context.Current.Request["GroupID"].Trim();
	}

	string layout = Model.Item.GetRawValueString("Layout", "field");
	var dropdownBorder = layout == "field" ? "" : "border-0"; 

	<div class="js-async-fetch-placeholder" @width>
		<div class="dropdown js-type-ahead-dropdown">
			<form 
				method="get" 
				action="@Dynamicweb.Frontend.SearchEngineFriendlyURLs.GetFriendlyUrl($"Default.aspx?ID={productListPage}")" 
				data-search-results-page="@searchResultsPageId" 
				data-product-details-page="@Dynamicweb.Frontend.SearchEngineFriendlyURLs.GetFriendlyUrl($"Default.aspx?ID={productDetailsPage}")" 
				data-product-list-page="@Dynamicweb.Frontend.SearchEngineFriendlyURLs.GetFriendlyUrl($"Default.aspx?ID={productListPage}")" 
				data-search-layout="@(layout)" class="js-suggest-form">

				<input type="hidden" class="js-type-ahead-parameter" />
				<input type="hidden" name="SearchLayout" value="@(layout)" />

				<label for="searchField" class="visually-hidden">@Translate("Search here")</label>

				<span class="bg-transparent h-100 position-absolute top-0 d-flex align-items-center justify-content-center pe-none @themeSearch" style="width: 2rem; left: 0.25rem;">
					<span class="icon-2 text-reset">
						@ReadFile(iconPath+"search.svg")
					</span>
				</span>

				<input 
					id="searchField"
					class="form-control js-type-ahead-field @searchFieldShape @themeSearch" 
					type="search" 
					placeholder="@Translate("Search here")" 
					autocomplete="off" 
					maxlength="255" 
					name="q" 
					value="@searchTerm" 
					data-original="@searchTerm">

				<button 
					type="reset" 
					id="resetSearch"
					class="btn btn-text bg-transparent reset-search @themeSearch" 
					aria-label="@Translate("Clear search")" 
					style="opacity: 0; position: absolute; top: 0; right: 0; visibility: hidden;"
					onclick="emptySearchField()">
					<span class="icon-2 position-relative" style="top: -1px;">
						@ReadFile(iconPath+"x.svg")
					</span>
				</button>
			</form>
			<ul class="dropdown-menu w-100 rounded-0 @dropdownBorder @themeResults js-type-ahead-menu" style="z-index: -1;"></ul>
		</div>	
	</div>
}
