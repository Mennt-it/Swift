@inherits Dynamicweb.Rendering.RazorTemplateBase<Dynamicweb.Rendering.RazorTemplateModel<Dynamicweb.Rendering.Template>>
@using Dynamicweb
@using System.IO

<div class="row">
	<div class="col-12 col-sm-10 col-md-8 col-lg-7 col-xl-6 mx-sm-auto">
		<form name="ordersubmit" id="ordersubmit" method="post" autocomplete="off">
			<section class="my-3 my-md-4">
				<div class="list-group">

					@if (!string.IsNullOrEmpty(GetString("Ecom:Order.ID")))
					{
						<div class="list-group-item py-2">
							<div class="row">
								<dt class="col-4 lh-base fw-normal text-nowrap">@Translate("Order number")</dt>
								<dd class="col-12 col-md-8 mb-0">@GetString("Ecom:Order.ID")</dd>
							</div>
						</div>
					}

					@if (!string.IsNullOrEmpty(GetString("Ecom:Order.Completed")))
					{
						<div class="list-group-item py-2">
							<div class="row">
								<dt class="col-4 lh-base fw-normal text-nowrap">@Translate("Order date")</dt>
								<dd class="col-12 col-md-8 mb-0">@GetString("Ecom:Order.Completed")</dd>
							</div>
						</div>
					}

					<div class="list-group-item py-2">
						<div class="row">
							<dt class="col-4 lh-base fw-normal text-nowrap">@Translate("Contact")</dt>
							<dd class="col-12 col-md-8 mb-0">
								@if (!string.IsNullOrEmpty(@GetString("Ecom:Order.Delivery.Email")))
								{
									<span>@GetString("Ecom:Order.Delivery.Email"), </span>
								}
								@if (!string.IsNullOrEmpty(@GetString("Ecom:Order.Delivery.Phone")))
								{
									<span>@GetString("Ecom:Order.Delivery.Phone")</span>
								}
							</dd>
						</div>
					</div>

					<div class="list-group-item py-2">
						<div class="row">
							<dt class="col-4 lh-base fw-normal text-nowrap">@Translate("Delivery address")</dt>
							<dd class="col-12 col-md-8 mb-0">
								@if (!string.IsNullOrEmpty(GetString("Ecom:Order.Delivery.Name")))
								{
									<span>@GetString("Ecom:Order.Delivery.Name"),</span>
								}
								@if (!string.IsNullOrEmpty(GetString("Ecom:Order.Delivery.Address")))
								{
									<span>@GetString("Ecom:Order.Delivery.Address"), </span>
								}
								@if (!string.IsNullOrEmpty(GetString("Ecom:Order.Delivery.Zip")))
								{
									<span>@GetString("Ecom:Order.Delivery.Zip")</span>
								}
								@if (!string.IsNullOrEmpty(GetString("Ecom:Order.Delivery.City")))
								{
									<span>@GetString("Ecom:Order.Delivery.City")</span>
								}
							</dd>
						</div>
					</div>

					<div class="list-group-item py-2">
						<div class="row">
							<dt class="col-4 lh-base fw-normal text-nowrap">@Translate("Billing address")</dt>
							<dd class="col-12 col-md-8 mb-0">
								@if (!string.IsNullOrEmpty(GetString("Ecom:Order.Customer.Name")))
								{
									<span>@GetString("Ecom:Order.Customer.Name"),</span>
								}
								@if (!string.IsNullOrEmpty(GetString("Ecom:Order.Customer.Address")))
								{
									<span>@GetString("Ecom:Order.Customer.Address"),</span>
								}
								@if (!string.IsNullOrEmpty(GetString("Ecom:Order.Customer.Zip")))
								{
									<span>@GetString("Ecom:Order.Customer.Zip")</span>
								}
								@if (!string.IsNullOrEmpty(GetString("Ecom:Order.Customer.City")))
								{
									<span>@GetString("Ecom:Order.Customer.City")</span>
								}
							</dd>
						</div>
					</div>

					@if (!string.IsNullOrEmpty(GetString("Ecom:Order.ShippingMethod")))
					{
						<div class="list-group-item py-2">
							<div class="row">
								<dt class="col-4 lh-base fw-normal text-nowrap">@Translate("Delivery method")</dt>
								<dd class="col-12 col-md-8 mb-0">@GetString("Ecom:Order.ShippingMethod")</dd>
							</div>
						</div>
					}

					@if (!string.IsNullOrEmpty(GetString("Ecom:Order.PaymentMethod")))
					{
						<div class="list-group-item py-2">
							<div class="row">
								<dt class="col-4 lh-base fw-normal text-nowrap">@Translate("Payment method")</dt>
								<dd class="col-12 col-md-8 mb-0">@GetString("Ecom:Order.PaymentMethod")</dd>
							</div>
						</div>
					}
				</div>
			</section>

			<section class="mb-4">
				<div class="list-group">
					<div class="list-group-item p-3 ">
						<div class="row row-cols-1 py-3 pt-md-0 gy-3">
							@foreach (LoopItem orderline in GetLoop("OrderLines"))
							{

								string name = orderline.GetString("Ecom:Order:OrderLine.ProductName");
								string image = "/Admin/Public/GetImage.ashx?width=" + 120 + "&height=" + 120 + "&crop=5&fillcanvas=true&Background=ffffff&image=" + orderline.GetString("Ecom:Product.PrimaryImage") + "&Format=WebP&Quality=100";
								string removeFromBasketLink = orderline.GetString("Ecom:Order:OrderLine.DeleteLink");
								string priceTotalWithDiscounts = orderline.GetString("Ecom:Order:OrderLine.TotalPriceWithProductDiscounts.PriceFormatted");
								string priceBefore = orderline.GetString("Ecom:Product.InformativePrice.PriceFormatted");
								string unitPrice = orderline.GetString("Ecom:Order:OrderLine.UnitPrice.PriceFormatted");
								string discountPrice = orderline.GetString("Ecom:Product.Discount.Price.PriceFormatted");
								string discountTotal = orderline.GetString("Ecom:Order:OrderLine.TotalDiscount.PriceFormatted");
								string variantText = orderline.GetString("Ecom:Order:OrderLine.ProductVariantText");
								var orderlineId = orderline.GetValue("Ecom:Order:OrderLine.Id");
								var quantity = orderline.GetDouble("Ecom:Order:OrderLine.Quantity");
								string primaryGroupId = orderline.GetString("Ecom:Order:OrderLine.PrimaryOrDefaultGroupId");
								string productId = orderline.GetString("Ecom:Order:OrderLine.ProductID");
								string variantId = orderline.GetString("Ecom:Order:OrderLine.ProductVariantID");

								string link = "#";
								string productDetailPageId = Pageview.CurrentParagraph.Item["ProductPageLink"] != null ? Pageview.CurrentParagraph.Item["ProductPageLink"].ToString() : "";
								productDetailPageId = productDetailPageId != "" ? productDetailPageId : GetPageIdByNavigationTag("ProductDetailPage").ToString();
								link = "Default.aspx?ID=" + productDetailPageId + "&ProductID=" + productId;
								if (!string.IsNullOrEmpty(variantId))
								{
									link += "&VariantID=" + variantId;
								}

								bool isProduct = orderline.GetBoolean("Ecom:Order:OrderLine.IsProduct");

								if (isProduct)
								{
									<article class="col">
										<div class="row gx-3">

											<div class="col-3">
												<a href="@link" class="ratio ratio-1x1 d-block " title="@name">
													<img src="@image" style="object-fit: contain;" alt="@name">
												</a>
											</div>

											<div class="col-9">

												<div class="row gx-2">

													<div class="col-8">

														<div class="row gx-2">
															<div class="col">
																@* Title *@
																<h3 class="h6 fs-7 mb-0">
																	<a href="@link" class="text-decoration-none" title="@name">@name</a>
																</h3>

																@* Variants *@
																@if (!string.IsNullOrEmpty(variantText))
																{
																	<p class="fs-8 mt-1 mb-0">@variantText</p>
																}

																@* Unit price *@
																<p class="fs-8 mt-1 mb-0">
																	@if (discountPrice == unitPrice)
																	{
																		<span class="d-block">
																			<span class="text-price">@unitPrice</span>
																		</span>
																	}
																	else
																	{
																		<span class="text-price">@discountPrice</span>
																		<span class="text-decoration-line-through">
																			<span class="text-price">@unitPrice</span>
																		</span>
																	}
																</p>
															</div>

															<div class="col-12">
																@* Quantity *@
																<span class="fs-8 d-block mt-1">@Translate("Quantity"): @quantity</span>
															</div>
														</div>

													</div>

													<div class="col-4 text-end">
														@* Total *@
														<span class="h6 mb-0 d-block fs-7">
															<span class="text-price">@priceTotalWithDiscounts</span>
														</span>
														@if (orderline.GetDouble("Ecom:Order:OrderLine.TotalDiscount.Price.Value") != 0)
														{
															<span class="m-0 d-block fs-8">
																<span class="text-price">@discountTotal</span>
															</span>
														}
													</div>
												</div>
											</div>
										</div>
									</article>
								}
								else
								{
									<article class="col">
										<div class="row gx-2">
											<div class="col-8">
												@* Title *@
												<h3 class="h6 fs-7 mb-0">
													<a href="@link" class="text-decoration-none" title="@name">@name</a>
												</h3>
											</div>
											<div class="col-4 text-end">
												@* Total *@
												<span class="h6 mb-0 d-block fs-7">
													<span class="text-price">@priceTotalWithDiscounts</span>
												</span>
												@if (orderline.GetDouble("Ecom:Order:OrderLine.TotalDiscount.Price.Value") != 0)
												{
													<span class="m-0 d-block fs-8">
														<span class="text-price">@discountTotal</span>
													</span>
												}
											</div>
										</div>
									</article>
								}
							}
						</div>
						@{

							string totalPriceWithoutDiscountsFeesAndTaxes = GetString("Ecom:Order.TotalPriceWithoutDiscountsFeesAndTaxes.PriceFormatted");
							string totalPriceWithoutOrderDiscountsAndFees = GetString("Ecom:Order.TotalPriceWithoutOrderDiscountsAndFees.PriceFormatted");

							<div class="fs-8 mb-3 border-top">

								@* Subtotal *@
								<div class="d-flex justify-content-between mb-2 fw-bold pt-2">
									<span>@Translate("Subtotal")</span>
									<span>
										@if (totalPriceWithoutDiscountsFeesAndTaxes != totalPriceWithoutOrderDiscountsAndFees)
										{
											<span class="text-price fw-normal text-decoration-line-through">@totalPriceWithoutDiscountsFeesAndTaxes</span>
										}
										<span class="text-price">@totalPriceWithoutOrderDiscountsAndFees</span>
									</span>
								</div>

								@* Discounts (only order discounts) *@
								@foreach (LoopItem orderline in GetLoop("OrderLines"))
								{
									bool isDiscount = orderline.GetBoolean("Ecom:Order:OrderLine.IsDiscount");
									bool isOrderDiscount = orderline.GetInteger("Ecom:Order:OrderLine.Type") == 1;
									if (isDiscount && isOrderDiscount)
									{
										<div class="d-flex justify-content-between mb-2"><span>@orderline.GetString("Ecom:Order:OrderLine.ProductName")</span><span>@orderline.GetString("Ecom:Order:OrderLine.TotalPriceWithProductDiscounts.PriceFormatted")</span></div>
									}
								}

								@* Shipping *@
								@if (!string.IsNullOrEmpty(GetString("Ecom:Order.ShippingMethodID")))
								{
									if (GetDouble("Ecom:Order.ShippingFee.Price.Value") != 0)
									{
										<div class="d-flex justify-content-between mb-2">
											<span>@Translate("Delivery")</span>
											<span>@GetString("Ecom:Order.ShippingFee.PriceFormatted")</span>
										</div>
									}
								}
								else
								{
									<div class="d-flex justify-content-between mb-2">
										<span>@Translate("Delivery")</span>
										<span>@Translate("Calculated in next step")</span>
									</div>
								}

								@* Payment *@
								@if (!string.IsNullOrEmpty(GetString("Ecom:Order.PaymentMethodID")))
								{
									if (GetDouble("Ecom:Order.PaymentFee.Price.Value") != 0)
									{
										<div class="d-flex justify-content-between mb-2">
											<span>@Translate("Payment")</span>
											<span class="text-price">@GetString("Ecom:Order.PaymentFee.PriceFormatted")</span>
										</div>
									}
								}
								else
								{
									<div class="d-flex justify-content-between mb-2">
										<span>@Translate("Payment")</span>
										<span>@Translate("Calculated in next step")</span>
									</div>
								}
							</div>
							<div class="fs-8 pt-3 border-top">
								<div class="d-flex justify-content-between mb-2 fs-6 fw-bold"><span>@Translate("Total")</span><span class="text-price fs-5">@GetString("Ecom:Order.Price.PriceFormatted")</span></div>
								<div class="d-flex justify-content-between mb-2"><span>@Translate("VAT")</span><span class="text-price">@GetString("Ecom:Order.Price.VATFormatted")</span></div>
								@if (GetDouble("Ecom:Order.TotalDiscount.Price.Value") != 0)
								{
									<div class="d-flex justify-content-between"><span>@Translate("Discount")</span><span class="text-price">@GetString("Ecom:Order.TotalDiscount.PriceFormatted")</span></div>
								}
							</div>
						}
					</div>
				</div>
			</section>
		</form>
	</div>
</div>
