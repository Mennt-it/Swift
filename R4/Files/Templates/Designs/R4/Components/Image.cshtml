@inherits Dynamicweb.Rendering.ViewModelTemplate<Dynamicweb.Frontend.ParagraphViewModel>
@using System.IO
@using System.Web
@using Dynamicweb.Frontend

@{
	FileViewModel image = Model?.Item?.GetFile("Image") ?? null;
}

@if (image != null)
	{
		string imagePath = image?.Path ?? "";
		imagePath = Dynamicweb.Context.Current.Server.UrlEncode(imagePath);

		int xPos = image?.FocalPositionFromLeft ?? 50;
		int yPos = image?.FocalPositionFromTop ?? 50;

		<!-- Image sizes + a fallback image -->
		string imagePathXS       = "/Admin/Public/GetImage.ashx?width=" + 320 + "&image=" + imagePath + "&Format=WebP&Quality=90";
		string imagePathS        = "/Admin/Public/GetImage.ashx?width=" + 480 + "&image=" + imagePath + "&Format=WebP&Quality=90";
		string imagePathM        = "/Admin/Public/GetImage.ashx?width=" + 640 + "&image=" + imagePath + "&Format=WebP&Quality=90";
		string imagePathL        = "/Admin/Public/GetImage.ashx?width=" + 1280 + "&image=" + imagePath + "&Format=WebP&Quality=90";
		string imagePathXL       = "/Admin/Public/GetImage.ashx?width=" + 1920 + "&image=" + imagePath + "&Format=WebP&Quality=90";
		string imagePathXXL      = "/Admin/Public/GetImage.ashx?width=" + 2560 + "&image=" + imagePath + "&Format=WebP&Quality=90";
		string imagePathFallBack = "/Admin/Public/GetImage.ashx?width=" + 1280 + "&image=" + imagePath + "&Format=WebP&Quality=90";

		<!-- attributes to send to the image tag -->
		string loading           = GetViewParameterString("loading");
		string cssClass          = GetViewParameterString("cssClass");
		string style             = GetViewParameterString("style");
		string alt               = GetViewParameterString("alt");

		if (Path.GetExtension(imagePath).ToLower() == ".svg") {
			@System.IO.File.ReadAllText(HttpContext.Current.Server.MapPath(imagePath))
		} else {
			<img 
				srcset="
					@imagePathXS   320w,
					@imagePathS    480w,
					@imagePathM    640w,
					@imagePathL   1280w,
					@imagePathXL  1920w,
					@imagePathXXL 2560w"
				sizes="
					(max-width: 1280px) 1280px, 
					640px
					"
				src="@imagePathFallBack"
				loading="@loading"
				class="@cssClass"
				style="
					object-fit: cover; 
					object-position: @(xPos)% @(yPos)%;
					@style;
				"
				alt="@alt">
		}
}
