@inherits Dynamicweb.Rendering.ViewModelTemplate<Dynamicweb.Frontend.ParagraphViewModel>
@using Dynamicweb.Content.Items
@using Dynamicweb.Content.Items.Queries

@functions {

	private int GetAreaId()
	{
		var areaId = Pageview.AreaID;

		return areaId;
	}

	private IEnumerable<Dynamicweb.Content.Items.Item> GetLists()
	{
		IEnumerable<Item> categories = null;

		using (Repository repo = ItemManager.Storage.Open("Swift_ArticleListPage"))
		{
			categories = repo.SelectByAreaId(GetAreaId(), new Query() { Amount = 100 }, true, true, false);
		}
		return categories;
	}

	private IEnumerable<Dynamicweb.Content.Items.Item> GetTagGroups()
	{
		IEnumerable<Item> tagGroups = null;

		using (Repository repo = ItemManager.Storage.Open("Swift_ArticleTagsCollection"))
		{
			tagGroups = repo.SelectByAreaId(GetAreaId(), new Query() { Amount = 100 }, true, true, false);
		}
		return tagGroups;
	}

	private IEnumerable<Dynamicweb.Content.Items.Item> GetTags()
	{
		IEnumerable<Item> tags = null;

		using (Repository repo = ItemManager.Storage.Open("Swift_ArticleTag"))
		{
			tags = repo.SelectByAreaId(GetAreaId(), new Query() { Amount = 100 }, true, true, false);
		}
		return tags;
	}

}

@{
	var query = Dynamicweb.Context.Current.Request.QueryString.Get("list");
	var facet = Model.Item?.GetRawValueString("Facet", "facet");
	var type = Model.Item?.GetRawValueString("Type", "list");
	var style = Model.Item?.GetRawValueString("Style", "dropdown");
	string theme = !string.IsNullOrWhiteSpace(Model.Item.GetRawValueString("Theme")) ? $"theme {Model.Item.GetRawValueString("Theme").Replace(" ", "").Trim().ToLower()} " : string.Empty;
	var alignment = Model.Item?.GetRawValueString("Alignment", "left");
	switch (alignment)
	{
		case "left":
			alignment = "align-items-start";
			break;
		case "center":
			alignment = "align-items-center";
			break;
		case "right":
			alignment = "align-items-end";
			break;
	}
	string contentPadding = Model.Item.GetRawValueString("ContentPadding", "");
	switch (contentPadding)
	{
		case "none":
			contentPadding = "p-0";
			break;
		case "small":
			contentPadding = "p-3 p-md-3";
			break;
		case "large":
			contentPadding = "p-5 p-md-5";
			break;
	}
}
<div class="d-flex flex-column @(theme)@(contentPadding) @(alignment)">

@{
	switch (facet)
	{
		case "facet":

			switch (type)
			{
				case "list":

					switch (style)
					{
						case "checkboxes":

							<div>

								@if (!string.IsNullOrEmpty(Model.Item.GetString("Title")) && !Model.Item.GetBoolean("HideTitle"))
								{
									string titleFontSize = Model.Item.GetRawValueString("TitleFontSize", "h3");
									string headingLevel = Model.Item.GetString("HeadingLevel", "h2");
									string headingLevelStart = $"<{headingLevel} class=\"{titleFontSize} mb-3\">";
									string headingLevelStop = $"</{headingLevel}>";

									@headingLevelStart
										@Model.Item.GetString("Title")
									@headingLevelStop
								}

								@foreach (var category in GetLists())
								{
									if (Dynamicweb.Core.Converter.ToInt32(category["PageId"]) != Pageview.Page.ID)
									{
									<div class="form-check form-check-inline">
										<label class="form-check-label" for="category_@category["PageId"]">@category["Title"]</label>
										<input class="form-check-input" type="checkbox" id="category_@category["PageId"]" name="list" value="@category["PageId"]" @(!string.IsNullOrEmpty(query) && query.Contains($"{category["PageId"]}") ? "checked" : string.Empty) />
									</div>
									}
								}
								<input class="btn btn-primary" type="submit" value="Apply filter" />
								
							</div>

							break;

						case "dropdown":

							@*<form action="" class="@(theme)@(contentPadding)" onchange="this.submit()">*@
								<select name="list" class="form-select" onchange="this.closest('form').submit()">
									<option value="" label="All" selected></option>
									@{
										foreach (var category in GetLists())
										{
											if (Dynamicweb.Core.Converter.ToInt32(category["PageId"]) != Pageview.Page.ID)
											{
												<option value="@category["PageId"]" label="@category["Title"]" @(!string.IsNullOrEmpty(query) && query.Equals($"{category["PageId"]}") ? "selected" : string.Empty)></option>
											}
										}
									}
								</select>
							@*</form>*@

							break;

						case "radiobuttons":

							@*<form action="" class="@(theme)@(contentPadding)" onchange="this.submit()">*@

								if (!string.IsNullOrEmpty(Model.Item.GetString("Title")) && !Model.Item.GetBoolean("HideTitle"))
								{
									string titleFontSize = Model.Item.GetRawValueString("TitleFontSize", "h3");
									string headingLevel = Model.Item.GetString("HeadingLevel", "h2");
									string headingLevelStart = $"<{headingLevel} class=\"{titleFontSize} mb-3\">";
									string headingLevelStop = $"</{headingLevel}>";

									@headingLevelStart
										@Model.Item.GetString("Title")
									@headingLevelStop
								}

								<div class="form-check form-check-inline">
									<label class="form-check-label" for="category_all">All</label>
									<input class="form-check-input" type="radio" id="category_all" name="list" value="" checked onchange="this.closest('form').submit()"/>
								</div>

								foreach (var category in GetLists())
								{
									if (Dynamicweb.Core.Converter.ToInt32(category["PageId"]) != Pageview.Page.ID)
									{
									<div class="form-check form-check-inline">
										<label class="form-check-label" for="category_@category["PageId"]">@category["Title"]</label>
										<input class="form-check-input" type="radio" id="category_@category["PageId"]" name="list" value="@category["PageId"]" @(!string.IsNullOrEmpty(query) && query.Contains($"{category["PageId"]}") ? "checked" : string.Empty) onchange="this.closest('form').submit()" />
									</div>
									}
								}

							@*</form>*@

							break;
					}

					break;

				case "tag-group":

					int groupId = !string.IsNullOrEmpty(Model.Item.GetRawValueString("TagGroup")) ? Model.Item.GetInt32("TagGroup") : 0;
					var group = groupId > 0 ? Dynamicweb.Services.Pages?.GetPage(groupId) : null;
					var groupName = group != null ? Dynamicweb.Frontend.ContentViewModelFactory.CreatePageInfoViewModel(group)?.Item?.GetString("Title") : string.Empty;
					var tags = Dynamicweb.Services.Paragraphs?.GetParagraphsByPageId(groupId);
					var tagGroupQuery = Dynamicweb.Context.Current.Request.QueryString.Get($"{@groupName.ToLower().Replace(" ", "-")}");

					switch (style)
					{
						case "dropdown":

							@*<form action="" class="@(theme)@(contentPadding)" onchange="this.submit()">*@
								
								if (!string.IsNullOrEmpty(Model.Item.GetString("Title")) && !Model.Item.GetBoolean("HideTitle"))
								{
									string titleFontSize = Model.Item.GetRawValueString("TitleFontSize", "h3");
									string headingLevel = Model.Item.GetString("HeadingLevel", "h2");
									string headingLevelStart = $"<{headingLevel} class=\"{titleFontSize} mb-3\">";
									string headingLevelStop = $"</{headingLevel}>";

									@headingLevelStart
										@Model.Item.GetString("Title")
									@headingLevelStop
								}

								<select name="Tags" class="form-select" onchange="this.closest('form').submit()">
								@*<select name="@groupName.ToLower().Replace(" ", "-")" class="form-select" onchange="this.closest('form').submit()">*@
									<option value="" label="@(groupName)" selected disabled></option>
									<option value="" label="All"></option>

									@{
										foreach (var tag in tags)
										{
											var tagItem = Dynamicweb.Frontend.ContentViewModelFactory.CreateParagraphInfoViewModel(tag)?.Item;

											<option value="@tag.ID" label="@tagItem.GetString("Title")" @(!string.IsNullOrEmpty(tagGroupQuery) && tagGroupQuery.Equals($"{tag.ID}") ? "selected" : string.Empty)></option>
										}
									}
								</select>
							@*</form>*@

							break;
					}

					break;
			}

			break;
		case "tag-cloud":
			
			var tagQuery = Dynamicweb.Context.Current.Request.QueryString.Get("Tags");
			@*<form action="" class="@(theme)@(contentPadding)" onchange="this.submit()">*@
				
				if (!string.IsNullOrEmpty(Model.Item.GetString("Title")) && !Model.Item.GetBoolean("HideTitle"))
				{
					string titleFontSize = Model.Item.GetRawValueString("TitleFontSize", "h3");
					string headingLevel = Model.Item.GetString("HeadingLevel", "h2");
					string headingLevelStart = $"<{headingLevel} class=\"{titleFontSize} mb-3\">";
					string headingLevelStop = $"</{headingLevel}>";

					@headingLevelStart
						@Model.Item.GetString("Title")
					@headingLevelStop
				}

				<div class="d-flex flex-wrap gap-2">
					<input class="btn-check" type="radio" id="tag_all" name="Tags" value="" checked onchange="this.closest('form').submit()"/>
					<label class="btn btn-primary btn-sm" for="tag_all">All</label>
					@foreach (var tag in GetTags())
					{
							<input class="btn-check" type="radio" id="tag_@tag["Id"]" name="Tags" value="@tag["Id"]" @(!string.IsNullOrEmpty(tagQuery) && tagQuery.Equals($"{tag["Id"]}") ? "checked" : string.Empty) onchange="this.closest('form').submit()"/>
							<label class="btn btn-primary btn-sm" for="tag_@tag["Id"]">@tag["Title"]</label>
					}
				</div>
			@*</form>*@
			<style>
				.btn-check:checked + .btn-primary {
					background-color: var(--swift-button-primary-hover-background-color);
					border: 0.0833rem solid var(--swift-button-primary-hover-border-color);
					color: var(--swift-button-primary-hover-foreground-color);
				}
			</style>

			break;
	}
}
</div>

