@inherits Dynamicweb.Rendering.ViewModelTemplate<Dynamicweb.Frontend.ParagraphViewModel>

@{
	string blockType = "article_block";
	
	var page = Dynamicweb.Services.Pages.GetPage(Pageview.ID);
	var settings = Dynamicweb.Frontend.ContentViewModelFactory.CreatePageInfoViewModel(page?.Parent).Item;
	var blockId = Model.ID;
	var block = Model.Item;

	var emailContentThemeId = settings.GetRawValueString("EmailContentTheme");
	var emailContentThemeParagraph = emailContentThemeId != null && emailContentThemeId != string.Empty ? Dynamicweb.Services.Paragraphs.GetParagraph(Dynamicweb.Core.Converter.ToInt32(emailContentThemeId)) : null;
	var emailContentTheme = emailContentThemeParagraph != null && Dynamicweb.Frontend.ContentViewModelFactory.CreateParagraphInfoViewModel(emailContentThemeParagraph).Item.GetString("CssClassName") != string.Empty ? Dynamicweb.Frontend.ContentViewModelFactory.CreateParagraphInfoViewModel(emailContentThemeParagraph)?.Item : null;

	var rowId = Pageview.CurrentParagraph.GridRowId;
	var row = Dynamicweb.Services.Grids.GetGridRowById(rowId);
	var rowItem = Dynamicweb.Services.Items.GetItem(row.ItemType, row.ItemId);
	var rowThemeId = Dynamicweb.Core.Converter.ToString(rowItem["ColumnBackground"]);
	var rowThemeParagraph = rowThemeId != null && rowThemeId != string.Empty ? Dynamicweb.Services.Paragraphs.GetParagraph(Dynamicweb.Core.Converter.ToInt32(rowThemeId)) : null;
	var rowTheme = rowThemeParagraph != null && Dynamicweb.Frontend.ContentViewModelFactory.CreateParagraphInfoViewModel(rowThemeParagraph).Item.GetString("CssClassName") != string.Empty ? Dynamicweb.Frontend.ContentViewModelFactory.CreateParagraphInfoViewModel(rowThemeParagraph)?.Item : null;

	var blockThemeId = block.GetRawValueString("Theme");
	var blockThemeParagraph = blockThemeId != null && blockThemeId != string.Empty ? Dynamicweb.Services.Paragraphs.GetParagraph(Dynamicweb.Core.Converter.ToInt32(blockThemeId)) : null;
	var blockTheme = blockThemeParagraph != null && Dynamicweb.Frontend.ContentViewModelFactory.CreateParagraphInfoViewModel(blockThemeParagraph).Item.GetString("CssClassName") != string.Empty ? Dynamicweb.Frontend.ContentViewModelFactory.CreateParagraphInfoViewModel(blockThemeParagraph)?.Item : rowTheme is object ? rowTheme : emailContentTheme;

	string backgroundColor = blockTheme != null ? "background-color: " + blockTheme.GetString("BackgroundColor") + ";" : string.Empty;
	string foregroundColor = blockTheme != null ? "color:" + blockTheme.GetString("ForegroundColor", "inherit") + ";" : string.Empty;
	string borderColor = blockTheme != null ? "border-color: " + blockTheme.GetString("BorderColor", "transparent") + ";" : string.Empty;
	string borders = block.GetRawValueString("Borders", "none");
	string borderThicknes = block.GetRawValueString("BorderThicknes", "0") + "px;";
	string borderClass = string.Empty;

	switch (borders)
	{
		case "top":
			borderClass = "border-top:" + borderThicknes + "border-top-style:solid;";
			break;
		case "bottom":
			borderClass = "border-bottom:" + borderThicknes + "border-bottom-style:solid;";
			break;
		case "top-bottom":
			borderClass = "border-top:" + borderThicknes + "border-bottom:" + borderThicknes + "border-style:solid; border-left:0; border-right: 0;";
			break;
		case "all":
			borderClass = "border:" + borderThicknes + "border-style:solid;";
			break;
	}

	string title = block.GetString("Title", string.Empty);
	string padding = "padding:" + block.GetRawValueString("Padding", "0") + "px;";
	string align = block.GetRawValueString("Align", "left");
	string text = Model.Item.GetString("Text", string.Empty);
	string lineHeight = "line-height:" + block.GetRawValueString("LineHeight", "1.5") + ";";
	var link = Model.Item.GetLink("Link");
}

<table id="@blockId" class="@blockType" align="center" border="0" cellpadding="0" cellspacing="0" role="presentation" style="mso-table-lspace:0pt;mso-table-rspace:0pt;color:inherit;width:100%;">
	<tbody>
		<tr>
			<td style="mso-line-height-rule:exactly;mso-text-raise:11px;mso-table-lspace:0pt;mso-table-rspace:0pt;font-weight:400;font-family:inherit;text-align:@align; @(backgroundColor)@(foregroundColor)@(padding)@(borderClass)@(borderColor) @(lineHeight)" width="100%">
				@RenderImage()
				@if (!string.IsNullOrEmpty(title)) {
					@RenderHeading(block, title)
				}
				@if (!string.IsNullOrEmpty(text))
				{
					@RenderText()
				}
				@if(link != null)
				{
					@RenderButton(link, blockTheme, align)
				}
			</td>
		</tr>
	</tbody>
</table>

@helper RenderHeading(Dynamicweb.Frontend.ItemViewModel block, string title)
{
	string heading = block.GetRawValueString("Heading", "h2");
	string fontStyle = block.GetRawValueString("FontStyle", "header");
	string fontSize = !string.IsNullOrEmpty(block.GetRawValueString("FontSize")) ? "font-size:" + block.GetRawValueString("FontSize") + "px;" : string.Empty;
	string lineHeight = "line-height:" + block.GetRawValueString("LineHeight", "1.5") + ";";

	string startTag = $"<{heading} class=\"{fontStyle}\" style=\"mso-line-height-rule: exactly; mso-text-raise: 11px; vertical-align: middle; margin-top: 0; margin-bottom: 8px; font-family:sans-serif;{fontSize}{lineHeight}\">";
	string endTag = $"</{heading}>";

	@startTag
	@title
	@endTag
}

@helper RenderText()
{
	string text = Model.Item.GetString("Text", string.Empty);

	<div style="mso-line-height-rule: exactly;mso-text-raise: 11px;vertical-align: middle; margin-top:0; margin-bottom:8px;">
		@text
	</div>
}

@helper RenderButton(Dynamicweb.Frontend.LinkViewModel link, Dynamicweb.Frontend.ItemViewModel theme, string align)

{
	var title = Model.Item.GetString("Title");
	var themeCssName = theme?.GetString("CssClassName",string.Empty);
	var backgroundColor = theme?.GetColor("ButtonPrimaryBackgroundColor");
	var backgroundColorDarken = backgroundColor?.Darken(10);
	var foregroundColor = theme?.GetColor("ButtonPrimaryForegroundColor");
	var borderColor = theme?.GetColor("ButtonPrimaryBorderColor");

	var parms = new Dictionary<string, object>();
	parms.Add("backgroundColor", backgroundColor);
	parms.Add("backgroundColorDarken", backgroundColorDarken);
	parms.Add("foregroundColor", foregroundColor);
	parms.Add("borderColor", borderColor);
	parms.Add("align", align);
	parms.Add("title", title);
	parms.Add("themeCssName", themeCssName);

	@RenderPartial("Swift_Email/Components/Button.cshtml", link ?? new Dynamicweb.Frontend.LinkViewModel(), parms)
}

@helper RenderImage()
{
	var parms = new Dictionary<string, object>();
	parms.Add("alt", Model.Item.GetString("ImageAltText"));
	parms.Add("columns", Model.GridRowColumnCount);

	@RenderPartial("Swift_Email/Components/Image.cshtml", Model.Item.GetFile("Image") ?? new Dynamicweb.Frontend.FileViewModel(), parms)
}
